<section id="loading">
   <style>
        /* Styles for the loading section itself, previously applied to body */
        section#loading {
            position: fixed; /* Cover the entire viewport */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #111; /* Base background for the loading screen */
            color: #fff;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Ensure it's on top */
            opacity: 1;
            transition: opacity 0.7s ease-out 0.3s, visibility 0s linear 1s; /* Fade out, then hide */
        }

        section#loading.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        :root {
            /* Using :host or a specific selector for the section if needed, but :root is fine if this style block is self-contained */
            --logo-char-initial-bg: linear-gradient(135deg, #7d7d7d 0%, #c0c0c0 50%, #8f8f8f 100%);
            --logo-char-bevel-dark: #2a2a2a;
            --logo-char-bevel-light: #e0e0e0;
            --logo-char-depth-shadow: rgba(0,0,0,0.5);
            
            --fire-text-color: #FF7700;
            --fire-glow1: #FF4500;
            --fire-glow2: #FF8C00;
            --fire-glow3: #FFA500;
            --fire-glow4: rgba(255,165,0,0.3);
            --anaglyph-red-color: rgba(255, 60, 130, 0.3);
            --anaglyph-cyan-color: rgba(0, 200, 255, 0.3);
            --scene-scale: 1;
            
            --loading-bar-bg: rgba(100,100,100,0.3);
            --loading-bar-fill: linear-gradient(90deg, #FF7700, #FFAA00, #FF7700);
            --loading-bar-glow: 0 0 8px rgba(255,100,0,0.7);
        }

        /* Styles for elements within section#loading */
        section#loading #background-effects-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; /* Behind other loading content */
            background-color: #111; /* Match section background */
            transition: background 0.5s ease-in-out; 
        }

        section#loading .bg-streak {
            position: absolute; opacity: 0; background-size: 200% 100%;
            filter: blur(12px); mix-blend-mode: screen;
            animation-timing-function: linear; animation-iteration-count: infinite;
            animation-play-state: paused; 
        }
        section#loading #bg-streak-1 {
            top: 10%; left: -100%; width: 200%; height: 15%;
            background: linear-gradient(90deg, transparent, var(--streak1-color, rgba(255, 200, 100, 0.3)) 50%, transparent);
            animation-name: streak-anim-horizontal; animation-duration: 5s;
        }
        section#loading #bg-streak-2 {
            bottom: 15%; right: -100%; width: 150%; height: 10%;
            background: linear-gradient(-90deg, transparent, var(--streak2-color, rgba(100, 200, 255, 0.25)) 50%, transparent);
            animation-name: streak-anim-horizontal-rev; animation-duration: 4.5s; animation-delay: 0.5s;
        }
        section#loading #bg-streak-3 { 
            top: 0%; left: 50%; width: 10%; height: 120%; 
            transform: translateX(-50%) skewX(-30deg);
            background: linear-gradient(180deg, transparent, var(--streak3-color, rgba(255, 255, 255, 0.2)) 40%, var(--streak3-color, rgba(255, 255, 255, 0.2)) 60%, transparent);
            animation-name: streak-anim-vertical-flash; animation-duration: 3s;
            animation-timing-function: ease-in-out; mix-blend-mode: overlay;
        }
        @keyframes streak-anim-horizontal {0%{transform:translateX(-100%);opacity:0}20%{opacity:1}80%{opacity:1}100%{transform:translateX(100%);opacity:0}}
        @keyframes streak-anim-horizontal-rev {0%{transform:translateX(100%);opacity:0}20%{opacity:1}80%{opacity:1}100%{transform:translateX(-100%);opacity:0}}
        @keyframes streak-anim-vertical-flash {0%,100%{opacity:0;transform:translateX(-50%) skewX(-30deg) scaleY(0.5)}5%,20%{opacity:0.7;transform:translateX(-50%) skewX(-30deg) scaleY(1)}25%{opacity:0}}

         /* Update the scene visibility initially */
    section#loading #scene {
        position:relative;
        width:100%;
        height:100%;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        perspective:1200px;
        transform-style:preserve-3d;
        transform:scale(var(--scene-scale));
        z-index:1;
        visibility: visible; /* Changed from hidden */
        opacity: 1; /* Changed from 0 */
    }
        section#loading #scene.visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s, 0s;
        }
        
        section#loading #loading-container {
            position: fixed; /* Changed from absolute to fixed */
            bottom: 60px; /* Position at bottom with some spacing */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
            padding: 20px 0; /* Add some padding */
        }
        section#loading #loading-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        section#loading #loading-bar {
            width: 300px;
            height: 4px;
            background: var(--loading-bar-bg);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px; /* Reduced margin */
            position: relative;
            box-shadow: var(--loading-bar-glow);
        }
        
        section#loading #loading-progress {
            height: 100%;
            width: 0%;
            background: var(--loading-bar-fill);
            background-size: 200% 100%;
            border-radius: 2px;
            transition: width 0.1s linear; 
            animation: loading-bar-pulse 2s linear infinite;
        }
        
        @keyframes loading-bar-pulse {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        section#loading #loading-text {
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            color: #aaa;
            margin-top: 8px; /* Reduced margin */
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        section#loading #initial-flare {
            position:absolute;top:50%;left:-150%;width:300%;height:50vh;
            background:linear-gradient(to right,transparent 0%,rgba(180,200,255,0.04) 35%,rgba(200,220,255,0.18) 50%,rgba(180,200,255,0.04) 65%,transparent 100%);
            filter:blur(35px);transform:translateY(-50%);opacity:0;z-index:100; /* High z-index within #scene */
        }
        @keyframes flare-sweep-anim {0%{left:-150%;opacity:0}10%{opacity:0.9}90%{opacity:0.9}100%{left:150%;opacity:0}}

        section#loading #logo-char-container {position:absolute;display:flex;justify-content:center;align-items:center;opacity:0;transform-style:preserve-3d}
        section#loading #logo-char {
            font-family:'Impact','Arial Black',sans-serif;font-size:35vh;font-weight:900;color:transparent;background:var(--logo-char-initial-bg);
            -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
            text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow);
            transform:scale(0.3) translateZ(-400px) rotateY(20deg);transform-style:preserve-3d;position:relative;z-index:2;
        }
        @keyframes logo-char-build-anim {0%{opacity:0;transform:scale(0.3) translateZ(-400px) rotateY(20deg)}100%{opacity:1;transform:scale(1) translateZ(0px) rotateY(0deg)}}
        @keyframes logo-char-spin-anim {0%{transform:scale(1) translateZ(0px) rotateY(0deg)}100%{transform:scale(1) translateZ(0px) rotateY(10deg)}}
        
        section#loading .particle-canvas {position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
        section#loading #logo-char-container canvas {z-index:1} 
        section#loading #main-name-container canvas {z-index:1} /* fire particles canvas */


        section#loading .bullet-flash {
            position:absolute;width:10vh;height:10vh;
            background:radial-gradient(circle,rgba(255,255,255,1) 0%,rgba(255,255,200,0.8) 25%,rgba(255,204,0,0.4) 50%,transparent 70%);
            border-radius:50%;opacity:0;transform:scale(0.5) translate(-50%,-50%);z-index:5;mix-blend-mode:screen;
        }
        section#loading #bullet-impact-flash-1 {top:35%;left:40%} 
        section#loading #bullet-impact-flash-2 {top:65%;left:60%}
        @keyframes bullet-flash-anim {0%{opacity:0;transform:scale(0.5) translate(-50%,-50%)}20%{opacity:1;transform:scale(1.1) translate(-50%,-50%)}100%{opacity:0;transform:scale(1.3) translate(-50%,-50%)}}
        @keyframes shockwave-ripple-anim {0%{text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow),0 0 0px rgba(255,255,255,0)}50%{text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow),0 0 20px rgba(255,255,255,0.6),0 0 10px rgba(255,255,255,0.9)}100%{text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow),0 0 0px rgba(255,255,255,0)}}
        @keyframes camera-shake-anim {0%,100%{transform:translate(0,0) scale(var(--scene-scale))}25%{transform:translate(-2px,1px) scale(var(--scene-scale))}50%{transform:translate(2px,-1px) scale(var(--scene-scale))}75%{transform:translate(-1px,1px) scale(var(--scene-scale))}}

        section#loading #light-bar {
            position:absolute;top:0%;left:-20%;width:7vh;height:100%;
            background:linear-gradient(to right,transparent 0%,rgba(255,255,255,0.15) 20%,rgba(255,255,255,0.65) 50%,rgba(255,255,255,0.15) 80%,transparent 100%);
            filter:blur(5px);transform:skewX(-20deg);opacity:0;z-index:3;
        }
        @keyframes light-bar-wipe-anim {0%{left:-20%;opacity:0.6}100%{left:120%;opacity:0.6}}
        @keyframes logo-char-shine-effect-anim {0%{text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow),0 0 0px rgba(255,255,255,0.0)}50%{text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow),0 0 18px rgba(255,255,255,0.7),0 0 25px rgba(255,255,255,0.5)}100%{text-shadow:1px 1px 0 var(--logo-char-bevel-dark),-1px -1px 0 var(--logo-char-bevel-light),2px 2px 3px var(--logo-char-depth-shadow),0 0 0px rgba(255,255,255,0.0)}}
        @keyframes logo-char-fade-out-anim {0%{opacity:1;transform:scale(1) translateZ(0px) rotateY(10deg)}100%{opacity:0;transform:scale(0.85) translateZ(-80px) rotateY(10deg)}}

        section#loading #main-name-container {
            position: absolute; 
            opacity: 0; 
            text-align: center; 
            width: 90%;
            transform: scale(1.5) translateZ(300px);
            display: flex; 
            flex-direction: column; 
            align-items: center;
            top: 50%;
            transform-origin: center;
            margin-top: -60px; /* Adjust this to position the name higher if needed */
        }
        section#loading .name-line { 
            display: flex; 
            flex-wrap: nowrap; 
            justify-content: center; 
            line-height: 1.0; 
            margin: 3px 0; 
        }
        
        section#loading .name-letter {
            font-family:'Consolas', 'Monaco', monospace;
            font-size:clamp(16px, 4vw, 52px); 
            font-weight:bold;color:var(--fire-text-color);opacity:0;
            margin:0 0.02em;position:relative; letter-spacing: -0.01em;
            text-transform: uppercase;
        }
        
        @keyframes main-name-zoom-in-anim {0%{opacity:0;transform:scale(1.5) translateZ(300px)}100%{opacity:1;transform:scale(1) translateZ(0px)}}
        
        @keyframes letter-load-and-ignite-anim { 
            0%, 8% { 
                opacity: var(--char-load-opacity, 0.4);
                color: var(--char-load-color, #666);
                text-shadow: none;
                transform: scale(0.9, 1.1) translateX(calc(var(--glitch-x) * 1px)) translateY(calc(var(--glitch-y) * 1px));
                filter: blur(0.8px);
            }
            12%, 20% { 
                opacity: 0.7;
                color: #FF6000;
                text-shadow: 0 0 2px #A02000;
                transform: scale(1.05, 0.95) translateX(calc(var(--glitch-x) * -0.3px)) translateY(calc(var(--glitch-y) * -0.3px));
                filter: blur(0.3px);
            }
            25%, 35% { 
                opacity: 0.9;
                color: #FF4500; 
                text-shadow: 0 0 4px #FF2000, 0 0 1px #8B0000;
                transform: scale(1);
                filter: none;
            }
            40% { 
                opacity: 1;
                color: #FFFFDD; 
                text-shadow: 0 0 10px #FFFFFF, 0 0 18px #FFFF99, 0 0 28px #FFCC66;
                transform: scale(1.03);
            }
            100% { 
                opacity: 1;
                color: var(--fire-text-color); 
                text-shadow: 
                    0 0 3px var(--fire-glow1), 0 0 6px var(--fire-glow2), 
                    0 0 10px var(--fire-glow3), 0 0 18px var(--fire-glow4);
                transform: scale(1);
            }
        }
        
        @keyframes scene-final-pulse-anim {0%{filter:brightness(1)}50%{filter:brightness(1.25)}100%{filter:brightness(1)}}
        @keyframes scene-push-back-anim {0%{--scene-scale:1;transform:scale(var(--scene-scale)) translateZ(0px)}100%{--scene-scale:0.93;transform:scale(var(--scene-scale)) translateZ(-70px)}}
    </style>

    <div id="background-effects-layer">
        <div class="bg-streak" id="bg-streak-1"></div>
        <div class="bg-streak" id="bg-streak-2"></div>
        <div class="bg-streak" id="bg-streak-3"></div>
    </div>
    
    <div id="loading-container">
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
        <div id="loading-text">Loading</div>
    </div>
    
    <div id="scene">
        <div id="initial-flare"></div>
        <div id="logo-char-container">
            <div id="logo-char">S</div>
            <canvas id="sparks-canvas" class="particle-canvas"></canvas>
            <canvas id="atmospheric-particles-canvas" class="particle-canvas"></canvas>
            <div class="bullet-flash" id="bullet-impact-flash-1"></div>
            <div class="bullet-flash" id="bullet-impact-flash-2"></div>
            <div id="light-bar"></div>
        </div>
        <div id="main-name-container">
            <div class="name-line" id="name-line-1"></div>
            <div class="name-line" id="name-line-2"></div>
            <canvas id="fire-particles-canvas" class="particle-canvas"></canvas>
        </div>
    </div>

    <script>
        // All JS code goes here, ensure selectors are prefixed with section#loading if needed, or ensure IDs are unique
        // For this self-contained example, direct ID selection is fine.
        const loadingSection = document.getElementById('loading'); // Get the section itself
        const scene = loadingSection.querySelector('#scene');
        const initialFlare = loadingSection.querySelector('#initial-flare');
        const backgroundLayer = loadingSection.querySelector('#background-effects-layer');
        const bgStreaks = [
            loadingSection.querySelector('#bg-streak-1'),
            loadingSection.querySelector('#bg-streak-2'),
            loadingSection.querySelector('#bg-streak-3')
        ];
        const logoCharContainer = loadingSection.querySelector('#logo-char-container');
        const logoChar = loadingSection.querySelector('#logo-char');
        const sparksCanvas = loadingSection.querySelector('#sparks-canvas');
        const atmosphericCanvas = loadingSection.querySelector('#atmospheric-particles-canvas');
        const bulletFlashes = [
            loadingSection.querySelector('#bullet-impact-flash-1'),
            loadingSection.querySelector('#bullet-impact-flash-2')
        ];
        const lightBar = loadingSection.querySelector('#light-bar');
        const mainNameContainer = loadingSection.querySelector('#main-name-container');
        const nameLine1El = loadingSection.querySelector('#name-line-1');
        const nameLine2El = loadingSection.querySelector('#name-line-2');
        const fireParticlesCanvas = loadingSection.querySelector('#fire-particles-canvas');
        const loadingContainer = loadingSection.querySelector('#loading-container');
        const loadingProgress = loadingSection.querySelector('#loading-progress');
        const loadingText = loadingSection.querySelector('#loading-text');

        const NAME_LINES = ["TIRUMALASETTY", "SASHI"]; 
        const LOGO_CHARS = ['S', 'A', 'S', 'H', 'I'];
        const LOGO_CHAR_DURATION = 1500; 
        const RANDOM_GLYPHS = ['█','▓','▒','░','#','*','$','%','&','?','§','0','1','X','_','|'];

        class Particle { 
            constructor(x, y, vx, vy, size, color, life, ctx, type = 'default', config = {}) {
                this.x = x; this.y = y; this.vx = vx; this.vy = vy; this.size = size; this.color = color;
                this.life = life; this.initialLife = life; this.ctx = ctx; this.type = type;
                this.gravity = config.gravity || 0; this.drag = config.drag || 0.985;
                this.initialOpacity = config.initialOpacity || (type === 'atmospheric' ? 0.3 : (type === 'fire' ? 0.75 : 0.85));
                this.opacity = this.initialOpacity; this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.1;
            }
            update() {
                this.x += this.vx; this.y += this.vy; this.vy += this.gravity;
                this.vx *= this.drag; this.vy *= this.drag; 
                if (this.type === 'fire') this.vy *= 0.965;
                this.life--;
                this.opacity = Math.max(0, this.initialOpacity * (this.life / this.initialLife));
                this.rotation += this.rotationSpeed;
            }
            draw() {
                if (this.life <= 0) return;
                this.ctx.globalAlpha = this.opacity; this.ctx.fillStyle = `rgb(${this.color})`;
                if (this.type === 'fire') {
                    this.ctx.filter = 'blur(1px)'; this.ctx.globalCompositeOperation = 'lighter';
                    this.ctx.fillStyle = `rgba(${this.color},${this.opacity*0.5})`;
                    this.ctx.beginPath();this.ctx.arc(this.x,this.y,this.size*1.2,0,Math.PI*2);this.ctx.fill();
                    let coreColorChannels = this.color.split(',').map(c=>Math.min(255,parseInt(c)+70)).join(',');
                    this.ctx.fillStyle = `rgba(${coreColorChannels},${this.opacity*0.9})`;
                    this.ctx.beginPath();this.ctx.arc(this.x+(Math.random()-0.5)*this.size*0.2,this.y+(Math.random()-0.5)*this.size*0.2,this.size*0.5,0,Math.PI*2);this.ctx.fill();
                    this.ctx.globalCompositeOperation = 'source-over'; this.ctx.filter = 'none';
                } else if (this.type === 'spark') {
                    this.ctx.beginPath(); this.ctx.rect(this.x - this.size/2, this.y - this.size*1.25, this.size, this.size*2.5); this.ctx.fill();
                } else {
                    this.ctx.beginPath(); this.ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); this.ctx.fill();
                }
                this.ctx.globalAlpha = 1;
            }
        }
        
        let particles = { sparks: [], atmospheric: [], fire: [] };
        let animationFrameId;
        let letterElements = [];

        function setupCanvas(canvasEl) { 
            if (!canvasEl) return null; // Guard against null element
            canvasEl.width = loadingSection.clientWidth; // Use section's dimensions
            canvasEl.height = loadingSection.clientHeight;
            return canvasEl.getContext('2d');
        }
        
        let sparksCtx, atmosphericCtx, fireCtx; // Declare here

        function initializeCanvases() { // Initialize contexts after DOM is ready
            sparksCtx = setupCanvas(sparksCanvas); 
            atmosphericCtx = setupCanvas(atmosphericCanvas); 
            fireCtx = setupCanvas(fireParticlesCanvas);
        }
        
        window.addEventListener('resize', () => {
            initializeCanvases(); // Re-initialize on resize
            if (mainNameContainer && mainNameContainer.style.opacity === '1') { // Check if mainNameContainer exists
                 letterElements.forEach(item => { 
                    if(item.el) item.rect = item.el.getBoundingClientRect();
                });
            }
        });

        function createSparks(count, charRect) { 
            if (!sparksCtx || !charRect) return;
            const cx=charRect.left+charRect.width/2, cy=charRect.top+charRect.height*0.6;
            for(let i=0;i<count;i++) particles.sparks.push(new Particle(cx+(Math.random()-0.5)*charRect.width*0.4,cy+(Math.random()-0.5)*charRect.height*0.15,(Math.random()-0.5)*2.5,(Math.random()*1.2+0.3),Math.random()*1+0.3,"255,190,70",Math.random()*20+10,sparksCtx,'spark',{gravity:0.08,drag:0.96}));
        }
        
        let atmosphericParticleInterval;
        function startAtmosphericParticles(color="150,150,180", density=30) { 
            if (!atmosphericCtx) return;
            clearInterval(atmosphericParticleInterval); particles.atmospheric=[];
            atmosphericParticleInterval=setInterval(()=>{if(particles.atmospheric.length<density){const x=Math.random()*atmosphericCanvas.width,y=Math.random()*atmosphericCanvas.height;particles.atmospheric.push(new Particle(x,y,(Math.random()-0.5)*0.2,(Math.random()-0.5)*0.2,Math.random()*1.8+0.8,color,Math.random()*150+90,atmosphericCtx,'atmospheric',{drag:0.99,initialOpacity:0.2+Math.random()*0.25}))}},250);
        }
        
        function stopAtmosphericParticles(quickFade=false) { 
            clearInterval(atmosphericParticleInterval); particles.atmospheric.forEach(p=>p.life=Math.min(p.life,quickFade?30:60));
        }
        
        function createFireParticles(letterItem) {
            if (!fireCtx || !letterItem || !letterItem.isBurning || !letterItem.rect) return;
            const rect=letterItem.rect, count=1+Math.floor(Math.random()*1.5);
            for(let i=0;i<count;i++){const x=rect.left+(Math.random()*rect.width*0.7)+(rect.width*0.15),y=rect.top+rect.height*(0.7+Math.random()*0.2),vx=(Math.random()-0.5)*0.5,vy=-(Math.random()*0.6+0.5),size=Math.random()*2.2+1.2,life=Math.random()*20+15;let color;const r=Math.random();if(r<0.5)color="255,100,0";else if(r<0.8)color="255,60,0";else color="255,160,0";particles.fire.push(new Particle(x,y,vx,vy,size,color,life,fireCtx,'fire',{gravity:-0.015,drag:0.95}))}
        }

        function animateParticles() { 
            if(sparksCtx) sparksCtx.clearRect(0,0,sparksCanvas.width,sparksCanvas.height);
            if(atmosphericCtx) atmosphericCtx.clearRect(0,0,atmosphericCanvas.width,atmosphericCanvas.height);
            if(fireCtx) fireCtx.clearRect(0,0,fireParticlesCanvas.width,fireParticlesCanvas.height); 

            ['sparks','atmospheric','fire'].forEach(type=>{particles[type]=particles[type].filter(p=>p.life>0);particles[type].forEach(p=>{p.update();p.draw()})});
            letterElements.forEach(item=>createFireParticles(item));
            animationFrameId = requestAnimationFrame(animateParticles);
        }
        
        function setBackgroundPhase(phaseName) { 
            bgStreaks.forEach(s=>s.style.animationPlayState='paused');let s1c="rgba(255,200,100,0.3)",s2c="rgba(100,200,255,0.25)",s3c="rgba(255,255,255,0.2)";
            if(phaseName==='s1'){backgroundLayer.style.background='radial-gradient(ellipse at 70% 30%,#50280F 0%,#381E00 25%,#1A0C00 55%,#000 100%),radial-gradient(ellipse at 20% 80%,#402008 0%,#201000 45%,#000 100%)';startAtmosphericParticles("180,120,80",25);s1c="rgba(255,180,100,0.35)";s3c="rgba(200,150,100,0.2)";bgStreaks[0].style.animationPlayState='running';bgStreaks[2].style.animationPlayState='running'}
            else if(phaseName==='a'){backgroundLayer.style.background='radial-gradient(ellipse at 30% 70%,#E0B020 0%,#B8860B 30%,#805000 60%,#000 100%),radial-gradient(ellipse at 80% 20%,#FFD700 0%,#FFA500 40%,#503000 70%,#000 100%)';startAtmosphericParticles("255,220,150",30);s1c="rgba(255,223,107,0.4)";s2c="rgba(255,210,80,0.3)";bgStreaks[0].style.animationPlayState='running';bgStreaks[1].style.animationPlayState='running'}
            else if(phaseName==='s2'){backgroundLayer.style.background='radial-gradient(ellipse at 70% 70%,#00A0B0 0%,#007780 30%,#003C40 60%,#000 100%),radial-gradient(ellipse at 20% 30%,#00E0F0 0%,#00BFFF 40%,#005060 70%,#000 100%)';startAtmosphericParticles("150,200,255",35);s2c="rgba(100,220,255,0.35)";s3c="rgba(180,230,255,0.25)";bgStreaks[1].style.animationPlayState='running';bgStreaks[2].style.animationPlayState='running'}
            else if(phaseName==='h'){backgroundLayer.style.background='radial-gradient(ellipse at 30% 30%,#D03010 0%,#A01C0A 30%,#600000 60%,#000 100%),radial-gradient(ellipse at 80% 80%,#FF4500 0%,#DC143C 40%,#400000 70%,#000 100%)';startAtmosphericParticles("255,150,150",25);s1c="rgba(255,100,100,0.4)";s3c="rgba(220,80,80,0.2)";bgStreaks[0].style.animationPlayState='running';bgStreaks[2].style.animationPlayState='running'}
            else if(phaseName==='i'){backgroundLayer.style.background='radial-gradient(ellipse at 50% 70%,#C00000 0%,#8B0000 30%,#400000 60%,#000 100%),radial-gradient(ellipse at 50% 20%,#FF0000 0%,#B22222 40%,#300000 70%,#000 100%)';startAtmosphericParticles("255,100,100",30);s1c="rgba(255,80,80,0.45)";s2c="rgba(255,120,120,0.3)";s3c="rgba(255,50,50,0.25)";bgStreaks[0].style.animationPlayState='running';bgStreaks[1].style.animationPlayState='running';bgStreaks[2].style.animationPlayState='running'}
            else if(phaseName==='final-name'){backgroundLayer.style.background='radial-gradient(ellipse at 50% 80%,rgba(60,10,0,0.7) 0%,rgba(40,0,0,0.5) 35%,#050100 65%),radial-gradient(ellipse at 50% 20%,rgba(100,40,0,0.4) 0%,#050100 55%),#020100';startAtmosphericParticles("100,40,20",30);s1c="rgba(255,100,0,0.1)";s2c="rgba(200,50,0,0.08)";bgStreaks[0].style.animationDuration='10s';bgStreaks[1].style.animationDuration='12s';bgStreaks[0].style.animationPlayState='running';bgStreaks[1].style.animationPlayState='running';bgStreaks[2].style.animationPlayState='paused'}
            else{backgroundLayer.style.background='#111';stopAtmosphericParticles(true)}
            document.documentElement.style.setProperty('--streak1-color',s1c);document.documentElement.style.setProperty('--streak2-color',s2c);document.documentElement.style.setProperty('--streak3-color',s3c);
        }
        
        async function processLogoLetter(char, bgPhase) { 
             return new Promise(resolve => {
                setBackgroundPhase(bgPhase); logoChar.textContent=char;
                logoCharContainer.style.animation='none';logoCharContainer.style.opacity='0';
                logoChar.style.animation='none';logoChar.style.transform='scale(0.3) translateZ(-400px) rotateY(20deg)';
                logoCharContainer.style.opacity='1';logoChar.style.animation=`logo-char-build-anim 0.3s ease-out forwards`;
                setTimeout(()=>{if(logoChar) { const charRect=logoChar.getBoundingClientRect();createSparks(50,charRect)};logoChar.style.animation=`logo-char-spin-anim 0.2s linear 0s forwards`},300);
                const impactDelays=[600,750];
                impactDelays.forEach((delay,index)=>{setTimeout(()=>{if(bulletFlashes[index]) bulletFlashes[index].style.animation=`bullet-flash-anim 0.1s ease-out forwards`;const currentTransform=window.getComputedStyle(logoChar).transform;logoChar.style.animation=`shockwave-ripple-anim 0.15s ease-out forwards`;if(scene) scene.style.animation=`camera-shake-anim 0.1s linear forwards`;if(logoChar) createSparks(30,logoChar.getBoundingClientRect());setTimeout(()=>{if(bulletFlashes[index]) bulletFlashes[index].style.animation='';if(scene) scene.style.animation='';logoChar.style.animation='';logoChar.style.transform=currentTransform},150)},delay)});
                setTimeout(()=>{logoChar.style.transform='scale(1) translateZ(0px) rotateY(10deg)';logoChar.style.animation='';if(lightBar) lightBar.style.animation=`light-bar-wipe-anim 0.2s ease-in-out forwards`;logoChar.style.animation=`logo-char-shine-effect-anim 0.15s ease-in-out 0.05s forwards`;setTimeout(()=>{if(lightBar) lightBar.style.animation='';logoChar.style.animation='';logoChar.style.transform='scale(1) translateZ(0px) rotateY(10deg)'},200)},950);
                setTimeout(()=>{logoCharContainer.style.animation=`logo-char-fade-out-anim 0.2s ease-in forwards`;resolve()},LOGO_CHAR_DURATION-200);
            });
        }

        function initializeMainName() { 
            nameLine1El.innerHTML='';nameLine2El.innerHTML='';letterElements=[];
            NAME_LINES[0].split('').forEach(char=>{const span=document.createElement('span');span.classList.add('name-letter');span.textContent=char;nameLine1El.appendChild(span);letterElements.push({el:span,isBurning:false,rect:null,originalChar:char})});
            NAME_LINES[1].split('').forEach(char=>{const span=document.createElement('span');span.classList.add('name-letter');span.textContent=char;nameLine2El.appendChild(span);letterElements.push({el:span,isBurning:false,rect:null,originalChar:char})});
        }
        
        async function revealMainName(bgPhase) {
            return new Promise(async resolve => {
                setBackgroundPhase(bgPhase); initializeMainName();
                if(mainNameContainer) {
                    mainNameContainer.style.opacity='0';mainNameContainer.style.animation=`main-name-zoom-in-anim 1s cubic-bezier(0.25,0.85,0.2,1) forwards`;
                }
                let revealDelay=600,stagger=45,preLoadDuration=180;

                for(let i=0;i<letterElements.length;i++){
                    const item=letterElements[i];
                    setTimeout(async()=>{
                        const originalText=item.originalChar;
                        item.el.style.setProperty('--glitch-x',(Math.random()-0.5)*5);item.el.style.setProperty('--glitch-y',(Math.random()-0.5)*5);
                        let noiseInterval=setInterval(()=>{item.el.textContent=RANDOM_GLYPHS[Math.floor(Math.random()*RANDOM_GLYPHS.length)];item.el.style.setProperty('--glitch-x',(Math.random()-0.5)*5);item.el.style.setProperty('--glitch-y',(Math.random()-0.5)*5)},35);
                        item.el.style.opacity='0.3';item.el.style.animation='none';
                        await new Promise(r=>setTimeout(r,preLoadDuration));
                        clearInterval(noiseInterval);item.el.textContent=originalText;
                        item.el.style.animation=`letter-load-and-ignite-anim 0.65s ease-out forwards`;item.el.style.opacity='1';
                        setTimeout(()=>{if(item.el) item.rect=item.el.getBoundingClientRect();item.isBurning=true},195);
                    },revealDelay+(i*stagger));
                }
                const totalRevealTime = revealDelay+(letterElements.length*stagger)+650;
                setTimeout(resolve, totalRevealTime); 
            });
        }

        async function finalSceneEffects() { 
            return new Promise(resolve => {
                if(scene) scene.style.animation=`scene-final-pulse-anim 0.7s ease-in-out forwards, scene-push-back-anim 1.8s ease-out 0.1s forwards`;
                stopAtmosphericParticles(false);
                setTimeout(()=>{letterElements.forEach(item=>item.isBurning=false);particles.fire.forEach(p=>p.life=Math.min(p.life,30))},1000);
                setTimeout(()=>{particles.atmospheric=[];particles.fire=[]; if(scene) scene.style.animation=''; resolve();},2500);
            });
        }
        
        let currentLoadingProgress = 0; // Renamed to avoid conflict
        let totalAnimationSteps = 1 + LOGO_CHARS.length + NAME_LINES[0].length + NAME_LINES[1].length + 1; // Updated count

        function updateLoadingBar() {
            currentLoadingProgress++;
            const percentage = Math.min(100, (currentLoadingProgress / totalAnimationSteps) * 100);
            if(loadingProgress) loadingProgress.style.width = `${percentage}%`;
            if(loadingText) {
                if (percentage < 30) loadingText.textContent = "Booting Systems...";
                else if (percentage < 70) loadingText.textContent = "Initializing Graphics...";
                else if (percentage < 100) loadingText.textContent = "Finalizing...";
                else loadingText.textContent = "Sequence Complete";
            }

            if (percentage >= 100) {
                 setTimeout(() => {
                    if(loadingContainer) loadingContainer.classList.add('hidden');
                    if(scene) scene.classList.add('visible');
                }, 500); 
            }
        }
         
        async function playSequence() {
            initializeCanvases(); // Initialize canvases first
            animateParticles(); 
            setBackgroundPhase('initial'); 
            currentLoadingProgress = 0; 
            if(loadingProgress) loadingProgress.style.width = `0%`; 
            if(loadingText) loadingText.textContent = "Loading";
           

            updateLoadingBar(); 
            if(initialFlare) initialFlare.style.animation = `flare-sweep-anim 1.2s ease-out forwards`;
            await new Promise(r => setTimeout(r, 1200));

            const bgPhases = ['s1','a','s2','h','i'];
            for (let i = 0; i < LOGO_CHARS.length; i++) {
                await processLogoLetter(LOGO_CHARS[i], bgPhases[i]);
                updateLoadingBar();
            }
            
            initializeMainName(); // Call before reveal to set up letterElements for progress
            const nameRevealPromise = revealMainName('final-name');
            
            let nameProgressCount = 0;
            const nameRevealStagger = 45; // Must match the stagger in revealMainName
            const nameUpdateInterval = setInterval(() => {
                if (nameProgressCount < letterElements.length) {
                    updateLoadingBar();
                    nameProgressCount++;
                } else {
                    clearInterval(nameUpdateInterval);
                }
            }, nameRevealStagger);

            await nameRevealPromise;
            clearInterval(nameUpdateInterval); // Ensure it's cleared
            // Top up any remaining progress for name letters if calculation was off
            while(currentLoadingProgress < (1 + LOGO_CHARS.length + letterElements.length)) {
                updateLoadingBar();
            }
            
            await finalSceneEffects();
            updateLoadingBar(); 
            
            if(loadingProgress) loadingProgress.style.width = `100%`;
            if(loadingText) loadingText.textContent = "Sequence Complete";
            setTimeout(() => {
                if(loadingContainer) loadingContainer.classList.add('hidden');
                if(scene) scene.classList.add('visible');
                if(loadingSection) loadingSection.classList.add('hidden'); // Hide the entire loading section
            }, 500); 
            
            setTimeout(() => { if(animationFrameId) cancelAnimationFrame(animationFrameId); }, 3000); 
        }
        
        // Use DOMContentLoaded to ensure all elements are available
        document.addEventListener('DOMContentLoaded', () => {
            // Check if the script is running inside the expected section
            if (document.getElementById('loading')) {
                playSequence().catch(error => {
                    console.error("Animation sequence failed:", error);
                    // Fallback: hide loading and show content if error occurs
                    const ldSc = document.getElementById('loading');
                    if (ldSc) ldSc.classList.add('hidden');
                });
            } else {
                console.error("Could not find #loading section. Animation will not run.");
            }
        });
    </script>
</section>

